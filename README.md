# ChatBot

## Настройки для запуска

Для настройки сервисов предусмотрены три файла

1. appsettings.json - общие настройки для среды development и production
2. appsettings.prod.json - настройки для сервиса ЛК и среды production
3. appsettings.prod-hub.json - настройки для сервиса чата и среды production

### Запуск сервисов по схеме Http

Параметры, которые необходимо изменить в своем рабочем окружении

1. В файлах appsettings.prod.json и appsettings.prod-hub.json нужно настроить конечные точки (Endpoints).
   Для Http существует раздел Http. Описание параметров для раздела находятся в файле KestrelServerOptionsExtensions.cs класс
   EndpointConfiguration. В CorsOrigins необходимо указать URL или маску приложения, которое работает на фронтенде, чтобы сервисы
   смогли разрешить запросы приходящие к ним от этого приложения
2. Для параметра ConnectionStrings.default указать строку подключения к БД
3. В файле appsettings.prod-hub необходимо указать URL, по которому будет работать сервис чата

### Запуск сервисов по схеме Https

1. В файлах appsettings.prod.json и appsettings.prod-hub.json нужно указать путь к сертификату с паролем.
   На данный момент указан сертификат (и пароль к нему) для разработки, его нужно заменить на тот, под которым
   работают ваше приложение, в которое будет внедряться Chatbot

### Запуск сервисов

Для работы ЛК и чата необходимо запустить два экземпляра одного и того же приложения, но в разных режимах.
Первый режим предназначен для обработки запросов от чата, второй для ЛК.
Запуск обоих сервисов осуществляется с помощью bat-файла run_prod.bat. При запуске сервисов один из них
осуществляет настройку БД (ее создание и настройку, если БД отсутствует) и ее наполнение первичными данными 
(политики безопасности и настройки).

## Сборка

Сборку сервисов можно осуществить с помощью студии Visual Studio 2019 (бесплатная версия Community).
1. Для решения Chatbot (открыть в студии файл Chatbot.sln) нужно выбрать проект Chatbot.Hosting, 
   правой кнопкой мыши открыть меню и выбрать пункт **Publish**. Выходная папка сборки bin\Release\netcoreapp5.0\publish\. 
   Содержимое папки нужно скопировать в папку, откуда будет производться запуск сервисов.
2. Решение lk_back предназначено для ЛК, перед сборкой решения необходимо собрать фронтенд ЛК, при этом 
   файлы сборки фронтенда ЛК, будут выгружены в папку wwwroot (перед сборкой фронтенда рекомендуется 
   очищать папку wwwroot). После этого можно собирать проект lk_back, по шагам описанным для решения
   Chatbot.


## Настройка фронтенда Чатбота и ЛК

1. В файле environment.prod.ts необходимо указать URL-адреса, под которым будет работать сервис ЛК и
   Чатбота - это ApiUrl и HubUrl соответственно.
2. После этого необходимо собрать оба приложения в режиме production. Для этого служит команда `npm run build`.
   Остальные команды можно посмотреть в файле **package.json**.
```
Для сборки приложений необходима установленная среда Node.js
``` 

## Настройка IIS для фронтендов ЛК и Чатбота

### ЛК

1. Создать приложение в IIS для ЛК
2. Создать папку для приложения и скопировать туда содержимое выходной папки сборки lk_back
3. В Пулах приложений, найти пул приложений для ЛК. Справа будет меню, найти и открыть "Основные настройки",
   "Версию среды для CLR.NET" выставить "Без управляемого кода"
   
### Чатбот
1. Создать приложение в IIS для Чатбота
2. Создать папку для приложения и скопировать туда содержимое выходной папки сборки фронтенда Чатбота.
   Выходная папка сборки фронтенда Чатбота находиться в папке Dist/Chatbot.
   
Для обоих приложений установить порты, по которым они будут работать и прописать их в настройках сервисов
Незабыть прописать эьт порты в файерволе


## Замечания

Сборку бэекнда в студии для обоих проектов (Chatbot.Hosting и lk_back) желательно производить после сборки
приложений фронтенда. Для работы в режиме Https для приложений Чатбота и ЛК, нужно настроить привязки
с использованием сертификата. Предварительно сертификат должен быть добавлен в IIS.
